# 总结

- [总结](#总结)
  - [测试驱动开发多线程的核心概念](#测试驱动开发多线程的核心概念)
  - [性能的要求](#性能的要求)
  - [设计异步方案](#设计异步方案)
    - [单元测试覆盖多线程](#单元测试覆盖多线程)

## 测试驱动开发多线程的核心概念

1. **分离线程逻辑和程序逻辑**：最好的面向对象的设计是尽可能地分离各种关注点。多线程应用程序设计也不例外。多线程是一个关注点，应用程序逻辑是另一个关注点。要尽可能地分离这些关注点，并将耦合降到最低。

2. **休眠方案很糟糕**：在线程中通过调用sleep_for()暂停执行，直到满足相应的条件，这种方案很糟糕。测试的运行会变慢，还会引发随机错误。更糟糕的是，真正的问题会被隐藏得更深、更久。

3. **简化特定的应用测试至单线程**：在引入多线程之前，应用程序代码首先确保必须能够再单线程环境下工作。为特定的应用测试提供消除并发性的方法，可以帮助你保持清醒。测试多线程往往最终会产生速度较慢的集成测试领域。

4. **在引入并发性控制之前，验证并发性问题**：在程序中滥用并发控制（Lock 和 Wait 即 同步）会极大降低应用程序的性能，甚至有可能解决不了任何真正的并发性问题。接下来的示例程序主要包含了以下核心内容：先编写一个可以演示潜在并发性问题的测试；`然后使其恶化，直到测试每次都会失败。`通过演示这些失败，首先能确保继续保持测试驱动的模式。你需要做的仅仅是增加并发性控制，以便测试可以通过。

## 性能的要求

通常引入多线最主要的原因往往都是性能上的要求。如本章节的例子中，搜索功能异步执行可以更快的给出响应，体验更好。

## 设计异步方案

异步方案设计基本遵顼**业务逻辑与线程实现细节的分离**。

### 单元测试覆盖多线程

1. 如何使用单元测试验证异步执行函数：可以采取 wait/notify 的策略。
2. 需要根据当前需求寻找一种方法，用强制手段让错误直接源于测试本身，而不是其他什么偶现的原因。
3. 多线程测试应当注意多条线程操作线程管理方法时是否存在[竞争状态](./9.md#暴露并发性问题)。
4. 多线程时操作同一个任务时这个竞争状态是否有[妥善处理](./9.md#在测试中创建客户端线程)。
5. 线程管理中多线程时处理任务时对于任务间竞争状态是否[妥善处理](./9.md#在-threadpool-中创建多个线程)。
